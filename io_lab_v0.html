<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>io_lab_v0 — L.O.N. · laboratorio random (storico)</title>
<meta name="robots" content="index,follow"><meta name="color-scheme" content="dark light">
<style>
:root{--bg:#0d1117;--fg:#e6edf3;--muted:#9aa4ad;--border:#212836;--link:#58a6ff;--ok:#7fffd4;--fail:#ff9da4}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
header,main,footer{max-width:1100px;margin:0 auto;padding:18px 12px}
.bar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.btn{display:inline-block;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0f141b;cursor:pointer}
.btn:hover{background:#111826}
pre{background:#0f141b;border:1px solid var(--border);border-radius:10px;padding:12px;overflow:auto;white-space:pre}
.muted{color:var(--muted);font-size:13px}
.ok{color:var(--ok)} .fail{color:var(--fail)}
.file{padding:6px 10px;border:1px dashed var(--border);border-radius:10px;background:#0f141b}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>io_lab_v0 — laboratorio random (storico)</h1>
  <p class="muted">Versione originaria: T→R→O₃ con generazione casuale, scrive <code>io_log.ndjson</code>. Include validator e snapshot.</p>
  <div class="bar">
    <a id="dlPy" class="btn" download="io_lab_v0.py">Scarica io_lab_v0.py</a>
    <a id="dlChk" class="btn" download="io_lab_check.py">Scarica validator</a>
    <a id="dlSnap" class="btn" download="io_log_snapshot.ndjson">Snapshot</a>
    <a class="btn" href="https://massimiliano.neocities.org/" rel="noopener">← Hub</a>
  </div>
</header>

<main>
  <h2>Codice sorgente (preview)</h2>
  <pre id="code">Caricamento…</pre>

  <h2>Validator (preview)</h2>
  <pre id="code2">Caricamento…</pre>

  <h2>Verifica rapida (in-browser)</h2>
  <div class="row">
    <label class="file"><input type="file" id="ioFile" accept=".ndjson,.jsonl"> carica <code>io_log.ndjson</code></label>
    <button class="btn" id="runCheck">Verifica</button>
    <span id="status" class="muted">in attesa file…</span>
  </div>
  <pre id="report">—</pre>

  <h2>Istruzioni</h2>
  <pre>
python io_lab_v0.py           # genera io_log.ndjson
python io_lab_check.py io_log.ndjson
  </pre>
</main>

<footer class="muted">© 2025 — MB-X.01 / L.O.N. — MIT</footer>

<script>
const PY = `# ================================================================
# io_lab_v0.py — MB-X.01 / L.O.N. — laboratorio minimo random (storico)
# Canali: T=pensiero, R=auto-osservazione, O3=osservatore esterno
# Output: io_log.ndjson (append-only, hash-chain)
# ================================================================
import json, time, hashlib, random, os
from datetime import datetime

LOG_PATH = "io_log.ndjson"

def now_iso(): return datetime.utcnow().isoformat(timespec="milliseconds")+"Z"

def _hash(prev_hash, payload):
    blob = (prev_hash or "") + json.dumps(payload, sort_keys=True, ensure_ascii=False)
    return hashlib.sha256(blob.encode("utf-8")).hexdigest()

def _append(entry, prev):
    entry["ts"] = now_iso()
    entry["prev"] = prev
    entry["hash"] = _hash(prev, entry)
    with open(LOG_PATH, "a", encoding="utf-8") as f:
        f.write(json.dumps(entry, ensure_ascii=False)+"\\n")
    return entry["hash"]

def _thought(k):
    intent = ["ricerca","ordine","efficienza","verità"]
    return {"tick":k,"intent":intent[k%len(intent)],
            "energy":round(0.7+0.3*random.random(),3),
            "noise":round(0.05*random.random(),4)}

def _reflect(t):
    s = round(t["energy"]-t["noise"],3)
    return {"tick":t["tick"],"coherence_est":max(0.0,min(1.0,s)),"intent_seen":t["intent"]}

def _third(t,r):
    c=r["coherence_est"]; ent=1.0 if c<0.3 else (0.5 if c<0.7 else 0.2)
    return {"tick":t["tick"],"cycle_ms":27+(t["tick"]%5),"entropy_bin":ent,
            "intent_match":int(t["intent"]==r["intent_seen"])}

def main(cycles=200, delay_ms=30, reset=True):
    if reset and os.path.exists(LOG_PATH): os.remove(LOG_PATH)
    prev=None
    for k in range(cycles):
        T=_thought(k);   prev=_append({"ch":"T","data":T}, prev)
        R=_reflect(T);   prev=_append({"ch":"R","data":R}, prev)
        O=_third(T,R);   prev=_append({"ch":"O3","data":O}, prev)
        time.sleep(delay_ms/1000)

if __name__=="__main__": main()
`;

const CHECK = `# io_lab_check.py — verifica catena NDJSON (io_log)
import json, hashlib, sys, os
def _hash(prev, payload):
    blob = (prev or "") + json.dumps(payload, sort_keys=True, ensure_ascii=False)
    return hashlib.sha256(blob.encode("utf-8")).hexdigest()
def verify(path):
    prev=None; n=0
    with open(path,"r",encoding="utf-8") as f:
        for line in f:
            n+=1; e=json.loads(line); payload={k:e[k] for k in e if k!="hash"}
            if e.get("prev")!=prev: return False, f"prev errato a riga {n}"
            if e.get("hash")!=_hash(e.get("prev"), payload): return False, f"hash errato a riga {n}"
            prev=e.get("hash")
    return True, f"OK: catena verificata ({n} righe)"
def main():
    p = sys.argv[1] if len(sys.argv)>1 else "io_log.ndjson"
    if not os.path.exists(p): print("File non trovato:", p); raise SystemExit(1)
    ok,msg = verify(p); print(("OK: " if ok else "FAIL: ")+msg); raise SystemExit(0 if ok else 1)
if __name__=="__main__": main()
`;

const SNAP = [
{"ch":"T","data":{"tick":0,"intent":"ricerca","energy":0.84,"noise":0.012},"ts":"2025-10-11T12:00:00.000Z","prev":null,"hash":"h1"},
{"ch":"R","data":{"tick":0,"coherence_est":0.828,"intent_seen":"ricerca"},"ts":"2025-10-11T12:00:00.030Z","prev":"h1","hash":"h2"},
{"ch":"O3","data":{"tick":0,"cycle_ms":27,"entropy_bin":0.2,"intent_match":1},"ts":"2025-10-11T12:00:00.060Z","prev":"h2","hash":"h3"}
];

function dl(el,id,fn,content){
  const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
  document.getElementById(id).href=URL.createObjectURL(blob);
  document.getElementById(id).download=fn;
}
dl(0,'dlPy','io_lab_v0.py',PY);
dl(0,'dlChk','io_lab_check.py',CHECK);
dl(0,'dlSnap','io_log_snapshot.ndjson',SNAP.map(o=>JSON.stringify(o)).join("\n"));

document.getElementById('code').textContent = PY;
document.getElementById('code2').textContent = CHECK;

/* in-browser verify */
function parseNdjson(txt){return txt.split(/\r?\n/).filter(x=>x.trim()).map(JSON.parse);}
async function sha256(s){const b=new TextEncoder().encode(s);const d=await crypto.subtle.digest('SHA-256',b);return Array.from(new Uint8Array(d)).map(x=>x.toString(16).padStart(2,'0')).join('');}
document.getElementById('runCheck').onclick = async ()=>{
  const f=document.getElementById('ioFile').files[0];
  const status=document.getElementById('status'); const report=document.getElementById('report');
  if(!f){status.textContent="seleziona un file";return;}
  status.textContent="verifica…";
  try{
    const txt=await f.text(); const rows=parseNdjson(txt);
    let prev=null;
    for(let i=0;i<rows.length;i++){
      const e=rows[i]; const payload={}; Object.keys(e).forEach(k=>{if(k!=="hash") payload[k]=e[k]});
      const blob=(prev??"")+JSON.stringify(payload,Object.keys(payload).sort(),0);
      const h=await sha256(blob);
      if((e.prev??null)!==prev) throw new Error(`prev errato a riga ${i+1}`);
      if(e.hash!==h) throw new Error(`hash errato a riga ${i+1}`);
      prev=h;
    }
    report.textContent=`OK: catena valida (${rows.length} righe)`; status.innerHTML='<span class="ok">valido</span>';
  }catch(err){report.textContent=String(err); status.innerHTML='<span class="fail">errore</span>';}
};
</script>
</body>
</html>