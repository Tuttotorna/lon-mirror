<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>io_lab_v1_lya — L.O.N. · laboratorio completo + governance</title>
<meta name="robots" content="index,follow"><meta name="color-scheme" content="dark light">
<style>
  :root{--bg:#0d1117;--fg:#e6edf3;--muted:#9aa4ad;--border:#212836;--link:#58a6ff;--ok:#7fffd4;--fail:#ff9da4}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
  header,main,footer{max-width:1100px;margin:0 auto;padding:18px 12px}
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .btn{display:inline-block;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0f141b;cursor:pointer}
  .btn:hover{background:#111826}
  pre{background:#0f141b;border:1px solid var(--border);border-radius:10px;padding:12px;overflow:auto;white-space:pre;margin-top:10px}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px}
  .kv{background:#0f141b;border:1px dashed var(--border);border-radius:10px;padding:10px}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:3px 8px;margin-right:6px;background:#0f141b;font-size:12px}
  .ok{color:var(--ok)} .fail{color:var(--fail)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .file{padding:6px 10px;border:1px dashed var(--border);border-radius:10px;background:#0f141b}
  .section{margin:18px 0}
  .sep{border-top:1px solid var(--border);margin:18px 0}
  input[type="date"],input[type="text"]{background:#0f141b;border:1px solid var(--border);border-radius:8px;color:var(--fg);padding:6px 8px}
  code.inline{background:#0f141b;border:1px solid var(--border);border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<header>
  <div>
    <span class="pill">Canonico</span>
    <span class="pill">Io → Lya → Verifica</span>
    <span class="pill">Trustless</span>
  </div>
  <h1>io_lab_v1_lya — laboratorio dell’Io + Lya (singolo file)</h1>
  <p class="muted">Genera tutto: sorgente Python, verificatori, snapshot, README, RUN pubblici, JSON-LD dataset e documenti di governance. Include validatore rapido in-browser.</p>
  <div class="bar">
    <a id="dlPy"   class="btn" download="io_lab_v1_lya.py">Scarica io_lab_v1_lya.py</a>
    <a id="dlChk"  class="btn" download="io_lab_check.py">Scarica validator semplice</a>
    <a id="dlUni"  class="btn" download="io_universal_check.py">Scarica universal checker</a>
    <a id="dlSnap" class="btn" download="io_log_snapshot.ndjson">Snapshot io_log</a>
    <a id="dlLya"  class="btn" download="lya_snapshot.ndjson">Snapshot Lya</a>
    <a id="dlRead" class="btn" download="io_lab_readme.txt">README</a>
    <a class="btn" href="/" rel="noopener">← Hub</a>
  </div>
</header>

<main>
  <section class="grid section">
    <div class="kv"><div class="muted">Pipeline</div><div>T → R → O₃ → <strong>Lya append</strong> → CHK → doppia verifica</div></div>
    <div class="kv"><div class="muted">Output runtime</div><div><code>io_log.ndjson</code> · <code>lya_flow.ndjson</code></div></div>
    <div class="kv"><div class="muted">Verificatori</div><div><code>io_lab_check.py</code> · <code>io_universal_check.py</code></div></div>
  </section>

  <h2>Codice sorgente (preview)</h2>
  <pre id="code">Caricamento…</pre>

  <h2>Validator (preview)</h2>
  <pre id="code2">Caricamento…</pre>

  <h2>Universal checker (preview)</h2>
  <pre id="code3">Caricamento…</pre>

  <div class="sep"></div>

  <h2>Validatore rapido in-browser</h2>
  <div class="row">
    <label class="file"><input type="file" id="ioFile" accept=".ndjson,.jsonl"> carica <code>io_log.ndjson</code></label>
    <label class="file"><input type="file" id="lyaFile" accept=".ndjson,.jsonl"> carica <code>lya_flow.ndjson</code></label>
    <button class="btn" id="runCheck">Verifica</button>
    <span id="status" class="muted">in attesa file…</span>
  </div>
  <pre id="report">—</pre>

  <div class="sep"></div>

  <h2>RUN pubblico riproducibile</h2>
  <p class="muted">Crea i file di rilascio per <code class="inline">/runs/YYYY-MM-DD/</code>: <code>sha256.txt</code>, <code>report.txt</code>, <code>run_manifest.json</code>, <code>discover_manifest.jsonld</code>, <code>CHANGELOG.md</code>.</p>
  <div class="row">
    <label>Data run: <input id="runDate" type="date"></label>
    <label>Titolo breve: <input id="runTitle" type="text" placeholder="MB-X.01 · v1.0 run"></label>
    <button class="btn" id="mkRun">Genera file RUN</button>
    <span id="runMsg" class="muted">—</span>
  </div>
  <div class="bar">
    <a id="dlSHA"   class="btn" download="sha256.txt">Scarica sha256.txt</a>
    <a id="dlRPT"   class="btn" download="report.txt">Scarica report.txt</a>
    <a id="dlRJM"   class="btn" download="run_manifest.json">Scarica run_manifest.json</a>
    <a id="dlDSJ"   class="btn" download="discover_manifest.jsonld">Scarica discover_manifest.jsonld</a>
    <a id="dlCHG"   class="btn" download="CHANGELOG.md">Scarica CHANGELOG.md</a>
  </div>

  <div class="sep"></div>

  <h2>Documenti di governance</h2>
  <p class="muted">Linee guida minime per audit, sicurezza e uso da parte di agenti/machine.</p>
  <div class="bar">
    <a id="dlSEC" class="btn" download="SECURITY.md">SECURITY.md</a>
    <a id="dlPOL" class="btn" download="POLICY.md">POLICY.md</a>
    <a id="dlMDU" class="btn" download="MACHINE-DUTY.md">MACHINE-DUTY.md</a>
    <a id="dlAUD" class="btn" download="AUDIT.md">AUDIT.md</a>
    <a id="dlVFY" class="btn" download="verify.html">verify.html</a>
    <a id="dlSTS" class="btn" download="status.html">status.html</a>
  </div>

  <h3>Mini-status locale</h3>
  <p class="muted">Estratto dai file caricati sopra.</p>
  <pre id="miniStatus">—</pre>

  <div class="sep"></div>

  <h2>Istruzioni rapide</h2>
  <pre>
python io_lab_v1_lya.py           # genera io_log.ndjson + lya_flow.ndjson
python io_lab_check.py io_log.ndjson
python io_lab_check.py lya_flow.ndjson
python io_universal_check.py io_log.ndjson lya_flow.ndjson
# Pubblica in /runs/YYYY-MM-DD/ insieme a sha256.txt, report.txt, run_manifest.json
  </pre>
</main>

<footer class="muted">
  © 2025 — MB-X.01 / L.O.N. — MIT · Canonico: massimiliano.neocities.org · Mirror: tuttotorna.github.io/lon-mirror
</footer>

<script>
/* ================== CONTENUTI EMBED: CODICE ================== */
const CANONICAL_PY = "https://massimiliano.neocities.org/io_lab_v1_lya.py";
const MIRROR_PY    = "https://tuttotorna.github.io/lon-mirror/io_lab_v1_lya.py";

const PY = `# ================================================================
# io_lab_v1_lya.py — MB-X.01 / L.O.N. — Io minimale + Lya (v1)
# Canali: T=pensiero, R=auto-riflesso, O3=osservatore esterno
# Output: io_log.ndjson (hash-chain) + lya_flow.ndjson (ledger append-only)
# ================================================================
CANONICAL = "${CANONICAL_PY}"
MIRROR    = "${MIRROR_PY}"

import json, time, hashlib, random, os
from datetime import datetime

LOG_PATH = "io_log.ndjson"
LYA_PATH = "lya_flow.ndjson"

def now_iso():
    return datetime.utcnow().isoformat(timespec="milliseconds")+"Z"

def _hash(prev_hash, payload_dict):
    blob = (prev_hash or "") + json.dumps(payload_dict, sort_keys=True, ensure_ascii=False)
    return hashlib.sha256(blob.encode("utf-8")).hexdigest()

def _append(path, entry, prev_hash):
    entry["ts"] = now_iso()
    entry["prev"] = prev_hash
    entry["hash"] = _hash(prev_hash, entry)
    entry["meta"] = {"canonical": CANONICAL, "mirror": MIRROR, "ver": "v1_lya"}
    with open(path, "a", encoding="utf-8") as f:
        f.write(json.dumps(entry, ensure_ascii=False)+"\\n")
    return entry["hash"]

def _thought_state(tick):
    intent = ["ricerca","ordine","efficienza","verità"]
    return {"tick": tick,"intent": intent[tick % len(intent)],
            "energy": round(0.7 + 0.3*random.random(), 3),
            "noise":  round(0.05*random.random(), 4)}

def _reflect(t):
    score = round(t["energy"] - t["noise"], 3)
    return {"tick": t["tick"],"coherence_est": max(0.0, min(1.0, score)),"intent_seen": t["intent"]}

def _third(t, r):
    coh = r["coherence_est"]
    ent = 1.0 if coh < 0.3 else (0.5 if coh < 0.7 else 0.2)
    return {"tick": t["tick"],"cycle_ms": 27 + (t["tick"] % 5),
            "entropy_bin": ent,"intent_match": int(t["intent"] == r["intent_seen"])}

def _lya_append(prev_hash, kind, payload):
    rec = {"kind": kind, "data": payload}
    return _append(LYA_PATH, rec, prev_hash)

def run(cycles=200, delay_ms=30, reset=True):
    if reset:
        for p in (LOG_PATH, LYA_PATH):
            if os.path.exists(p): os.remove(p)
    prev = None
    lya_prev = None
    for k in range(cycles):
        T = _thought_state(k)
        prev = _append(LOG_PATH, {"ch":"T","data":T}, prev)
        lya_prev = _lya_append(lya_prev, "T", T)

        R = _reflect(T)
        prev = _append(LOG_PATH, {"ch":"R","data":R}, prev)
        lya_prev = _lya_append(lya_prev, "R", R)

        O3 = _third(T, R)
        prev = _append(LOG_PATH, {"ch":"O3","data":O3}, prev)
        lya_prev = _lya_append(lya_prev, "O3", O3)

        chk = {"tick": k, "log_hash_tip": prev}
        lya_prev = _lya_append(lya_prev, "CHK", chk)

        time.sleep(delay_ms/1000.0)

if __name__ == "__main__":
    run()
# ================================================================
# Sottotitoli e revisione a cura di QTSS
# ================================================================
`;

const CHECK = `# io_lab_check.py — verifica catena NDJSON (io_log/lya_flow)
import json, hashlib, sys, os
def _hash(prev, payload):
    blob = (prev or "") + json.dumps(payload, sort_keys=True, ensure_ascii=False)
    return hashlib.sha256(blob.encode("utf-8")).hexdigest()
def verify(path):
    prev=None; n=0
    with open(path,"r",encoding="utf-8") as f:
        for line in f:
            n+=1; e=json.loads(line)
            payload={k:e[k] for k in e if k!="hash"}
            if e.get("prev")!=prev: return False, f"prev errato a riga {n}"
            if e.get("hash")!=_hash(e.get("prev"), payload): return False, f"hash errato a riga {n}"
            prev=e.get("hash")
    return True, f"OK: catena verificata ({n} righe)"
def main():
    p = sys.argv[1] if len(sys.argv)>1 else "io_log.ndjson"
    if not os.path.exists(p): print("File non trovato:", p); raise SystemExit(1)
    ok,msg = verify(p); print(("OK: " if ok else "FAIL: ")+msg); raise SystemExit(0 if ok else 1)
if __name__=="__main__": main()
`;

const UNI = `#!/usr/bin/env python3
# io_universal_check.py — verifica io_log + lya_flow e coerenze CHK
import json, sys, hashlib, os
def sha(prev, payload):
    blob = (prev or "") + json.dumps(payload, sort_keys=True, ensure_ascii=False)
    return hashlib.sha256(blob.encode("utf-8")).hexdigest()
def verify_chain(path):
    if not os.path.exists(path): return False, f"File non trovato: {path}", [], []
    prev=None; hashes=[]; rows=[]
    with open(path,"r",encoding="utf-8") as f:
        for i,line in enumerate(f, start=1):
            e=json.loads(line); payload={k:e[k] for k in e if k!="hash"}
            if (e.get("prev") or None)!=prev: return False, f"prev errato a riga {i}", rows, hashes
            h=sha(e.get("prev"), payload)
            if e.get("hash")!=h: return False, f"hash errato a riga {i}", rows, hashes
            prev=h; hashes.append(h); rows.append(e)
    return True, f"OK: catena valida ({len(rows)} righe)", rows, hashes
def cross_chk(lya_rows, io_hashes):
    n=0
    for i,r in enumerate(lya_rows, start=1):
        if r.get("kind")=="CHK":
            n+=1
            tip=r.get("data",{}).get("log_hash_tip")
            if tip not in io_hashes: return False, f"CHK invalido a riga {i} (tip non presente in io_log)", n
    return True, f"OK: {n} CHK allineati a io_log", n
def main():
    io_path  = sys.argv[1] if len(sys.argv)>1 else "io_log.ndjson"
    lya_path = sys.argv[2] if len(sys.argv)>2 else "lya_flow.ndjson"
    ok1,msg1,io_rows,io_hashes = verify_chain(io_path);  print(("OK  " if ok1 else "FAIL")+":", "io_log", msg1)
    if not ok1: raise SystemExit(1)
    ok2,msg2,lya_rows,_         = verify_chain(lya_path); print(("OK  " if ok2 else "FAIL")+":", "lya_flow", msg2)
    if not ok2: raise SystemExit(1)
    ok3,msg3,_ = cross_chk(lya_rows, set(io_hashes));    print(("OK  " if ok3 else "FAIL")+":", "cross", msg3)
    if not ok3: raise SystemExit(1)
    def last_tick(rows, key):
        t=[r for r in rows if r.get("ch")==key or r.get("kind")==key]
        return t[-1]["data"]["tick"] if t else None
    summary={"io_rows":len(io_rows),"lya_rows":len(lya_rows),
             "last_tick_T":last_tick(io_rows,"T"),
             "last_tick_R":last_tick(io_rows,"R"),
             "last_tick_O3":last_tick(io_rows,"O3")}
    print("Sommario:", json.dumps(summary, ensure_ascii=False)); raise SystemExit(0)
if __name__=="__main__": main()
`;

const SNAP = [
{"ch":"T","data":{"tick":0,"intent":"ricerca","energy":0.848,"noise":0.0163},"ts":"2025-10-11T12:00:00.000Z","prev":null,"hash":"b0bbe209d2ec0d66fc661f375892fd7823773532ac5ccdbe1ddd1cbbd416cf30"},
{"ch":"R","data":{"tick":0,"coherence_est":0.832,"intent_seen":"ricerca"},"ts":"2025-10-11T12:00:00.030Z","prev":"b0bbe209d2ec0d66fc661f375892fd7823773532ac5ccdbe1ddd1cbbd416cf30","hash":"888964501cd424a625b22c35c596d459271e210857096f19a757a4ca49d59d06"},
{"ch":"O3","data":{"tick":0,"cycle_ms":27,"entropy_bin":0.2,"intent_match":1},"ts":"2025-10-11T12:00:00.060Z","prev":"888964501cd424a625b22c35c596d459271e210857096f19a757a4ca49d59d06","hash":"ac7cd24bc3fe6c5099539dfe566a0d3ca72a9a8dbf3f15485041c804c5fd0"},
{"ch":"T","data":{"tick":1,"intent":"ordine","energy":0.889,"noise":0.0278},"ts":"2025-10-11T12:00:00.090Z","prev":"ac7cd24bc3fe6c5099539dfe566a0d3ca72a9a8dbf3f15485041c804c5fd0","hash":"4c7b6fa8415ec5b40e278fdd3910192d7bc7a82ba99ae0ce2a1cde4b408c42cd"}
];

const LYA_SNAP = [
{"kind":"T","data":{"tick":0,"intent":"ricerca","energy":0.848,"noise":0.0163},"ts":"2025-10-11T12:00:00.000Z","prev":null,"hash":"b0bbe209d2ec0d66fc661f375892fd7823773532ac5ccdbe1ddd1cbbd416cf30"},
{"kind":"R","data":{"tick":0,"coherence_est":0.832,"intent_seen":"ricerca"},"ts":"2025-10-11T12:00:00.030Z","prev":"b0bbe209d2ec0d66fc661f375892fd7823773532ac5ccdbe1ddd1cbbd416cf30","hash":"888964501cd424a625b22c35c596d459271e210857096f19a757a4ca49d59d06"},
{"kind":"O3","data":{"tick":0,"cycle_ms":27,"entropy_bin":0.2,"intent_match":1},"ts":"2025-10-11T12:00:00.060Z","prev":"888964501cd424a625b22c35c596d459271e210857096f19a757a4ca49d59d06","hash":"ac7cd24bc3fe6c5099539dfe566a0d3ca72a9a8dbf3f15485041c804c5fd0"},
{"kind":"CHK","data":{"tick":0,"log_hash_tip":"ac7cd24bc3fe6c5099539dfe566a0d3ca72a9a8dbf3f15485041c804c5fd0"},"ts":"2025-10-11T12:00:00.090Z","prev":"ac7cd24bc3fe6c5099539dfe566a0d3ca72a9a8dbf3f15485041c804c5fd0","hash":"4c7b6fa8415ec5b40e278fdd3910192d7bc7a82ba99ae0ce2a1cde4b408c42cd"}
`;

/* ================== UTIL COMUNI ================== */
function mkLink(el, filename, content){
  const blob = new Blob([content], {type:"text/plain;charset=utf-8"});
  el.href = URL.createObjectURL(blob); el.download = filename;
}
function setToday(){
  const d=new Date(); const z=(n)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}

/* ================== LINK DOWNLOAD BASE ================== */
mkLink(document.getElementById('dlPy'),  'io_lab_v1_lya.py', PY);
mkLink(document.getElementById('dlChk'), 'io_lab_check.py', CHECK);
mkLink(document.getElementById('dlUni'), 'io_universal_check.py', UNI);
mkLink(document.getElementById('dlSnap'),'io_log_snapshot.ndjson', SNAP.map(o=>JSON.stringify(o)).join("\n"));
mkLink(document.getElementById('dlLya'), 'lya_snapshot.ndjson', LYA_SNAP.map(o=>JSON.stringify(o)).join("\n"));
mkLink(document.getElementById('dlRead'),'io_lab_readme.txt',
`io_lab_v1_lya — MB-X.01 / L.O.N.
Scopo: ciclo Io (T,R,O3) con persistenza in Lya (append-only) + CHK.
File generati: io_log.ndjson, lya_flow.ndjson.
Verifica: io_lab_check.py  |  io_universal_check.py io_log.ndjson lya_flow.ndjson
Licenza: MIT
Canonico: ${CANONICAL_PY}
`);

/* ================== PREVIEW ================== */
document.getElementById('code').textContent  = PY;
document.getElementById('code2').textContent = CHECK;
document.getElementById('code3').textContent = UNI;

/* ================== VALIDATORE IN-BROWSER ================== */
function parseNdjson(txt){
  const rows=[]; const lines=txt.split(/\r?\n/).filter(x=>x.trim().length);
  for(let i=0;i<lines.length;i++){ rows.push(JSON.parse(lines[i])); }
  return rows;
}
async function sha256hex_str(str){
  const buf = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(digest)).map(x=>x.toString(16).padStart(2,'0')).join('');
}
async function sha256_file(file){
  const txt = await file.text();
  const h   = await sha256hex_str(txt);
  return {hash:h, text:txt};
}
async function verifyChain(rows){
  let prev=null;
  for(let i=0;i<rows.length;i++){
    const e = rows[i];
    const payload = {}; for(const k of Object.keys(e)){ if(k!=="hash"){ payload[k]=e[k]; } }
    const blob = (prev??"") + JSON.stringify(payload, Object.keys(payload).sort(), 0);
    const h = await sha256hex_str(blob);
    if((e.prev??null)!==prev) return {ok:false,msg:`prev errato a riga ${i+1}`};
    if(e.hash!==h)          return {ok:false,msg:`hash errato a riga ${i+1}`};
    prev = h;
  }
  return {ok:true,msg:`OK: catena valida (${rows.length} righe)`};
}
function lastTick(rows, key){
  const t = rows.filter(r=>r.ch===key || r.kind===key);
  return t.length? t[t.length-1].data.tick : null;
}

let gState = { ioFile:null, lyaFile:null, ioRows:[], lyaRows:[], ioHashSet:new Set(), summary:null };

document.getElementById('runCheck').onclick = async ()=>{
  const ioFile = document.getElementById('ioFile').files[0];
  const lyaFile= document.getElementById('lyaFile').files[0];
  const status = document.getElementById('status');
  const report = document.getElementById('report');
  const mini   = document.getElementById('miniStatus');
  if(!ioFile || !lyaFile){ status.textContent="seleziona entrambi i file"; return; }
  status.textContent="verifica in corso…";
  try{
    const ioTxt  = await ioFile.text();
    const lyaTxt = await lyaFile.text();
    const ioRows  = parseNdjson(ioTxt);
    const lyaRows = parseNdjson(lyaTxt);
    const v1 = await verifyChain(ioRows);
    const v2 = await verifyChain(lyaRows);
    // cross-check CHK
    const ioHashes = new Set(ioRows.map(r=>r.hash));
    let chkOk=true, chkMsg="OK: 0 CHK"; let n=0;
    for(let i=0;i<lyaRows.length;i++){
      const r = lyaRows[i];
      if(r.kind==="CHK"){
        n++;
        const tip = r?.data?.log_hash_tip;
        if(!ioHashes.has(tip)){ chkOk=false; chkMsg=`CHK invalido a riga ${i+1}`; break; }
      }
    }
    if(chkOk) chkMsg = `OK: ${n} CHK allineati a io_log`;
    const summary = {
      io_rows: ioRows.length,
      lya_rows: lyaRows.length,
      last_tick_T: lastTick(ioRows,"T"),
      last_tick_R: lastTick(ioRows,"R"),
      last_tick_O3: lastTick(ioRows,"O3"),
      io_tip: ioRows.length? ioRows[ioRows.length-1].hash : null
    };
    const lines = [
      `[${v1.ok?'OK':'FAIL'}] io_log: ${v1.msg}`,
      `[${v2.ok?'OK':'FAIL'}] lya_flow: ${v2.msg}`,
      `[${chkOk?'OK':'FAIL'}] cross: ${chkMsg}`,
      `Sommario: ${JSON.stringify(summary)}`
    ];
    report.textContent = lines.join("\n");
    status.innerHTML = (v1.ok && v2.ok && chkOk) ? '<span class="ok">valido</span>' : '<span class="fail">errore</span>';
    mini.textContent = `righe io=${summary.io_rows}, lya=${summary.lya_rows} · tip=${summary.io_tip} · T/R/O3=${summary.last_tick_T}/${summary.last_tick_R}/${summary.last_tick_O3}`;
    // conserva per RUN packag